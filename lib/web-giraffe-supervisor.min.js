!function(a,b){function c(){}function d(){this.handlers={},this.defaultHandler=function(a){console.warn("Unhandled command ",a)}}function e(){this.id=0}function f(a,b){function d(a,d){if(void 0===a.replyTo)return void console.warn("replyTo required on message ",a);try{if(d){if(a.transfered)throw new Error("Transfer list conflict");a.transfered=d.ports}var f,g=a.progressName;f=g?function(a){e.send({command:g,details:a})}.bind(this):c;var h=Promise.resolve(b(a,f));h.then(function(b){var c=b.transfer?b.transfer:[];delete b.transfer,e.send({command:a.replyTo,success:!0,result:b},c)},function(b){e.send({command:a.replyTo,success:!1,error:b.toString()})})}catch(i){e.send({command:a.replyTo,success:!1,error:i.toString()})}}if(!b)throw new Error("handler required");var e=this;this.register(a,d)}function g(a){var b=this.namer.next();a.progressName=b;var d=this;this.register(b,function(a){var b=a.details;e.onProgress(b)});var e=this.withReplyTo(a);return e.then(function(){d.unregister(b)},function(){d.unregister()}),e.onProgress=c,e}function h(a){if(a.replyTo)throw new Error("replyTo not allowed (used by the protocol)");var b=this.namer.next(),c=this.promiseMessage(b).then(function(b){if(b.success){var c=b.result;return b.transfered&&b.transfered.length>0&&(c.transfered=b.transfered),c}throw new Error(b.error?b.error:"Command failed to properly respond for "+a.command)});a.replyTo=b;var d=a.transfer?a.transfer:[];return delete a.transfer,this.send(a,d),c}function i(a,b){this.port.postMessage(a,b)}function j(){var a={};return a.expiresAt=function(a,b){var c=setTimeout(b,a);return{cancel:function(){clearTimeout(c)}}},a}function k(a){a=a||j();var b=[];return b.timeout=1e3,b.enqueue=function(d,e){e=e||c;var f=a.expiresAt(b.timeout,function(){b.splice(b.lastIndexOf(g),1),e()}),g={datum:d,cancelTimer:function(){f.cancel()}};b.push(g)},b.dequeue=function(){if(0==b.length)throw new Error("empty");var a=b.pop();return a.cancelTimer(),a.datum},b}function l(a,b){b=b||1;var c=[],d=k(),e=0,f={};return f.timeout=1e3,f.idling=function(a){var b=new m;if(c.length>0){var f=c.pop();a.assign(f),b.resolve({command:"assigned"})}else d.enqueue(a,function(){b.resolve({command:"terminating"}),e--,a.terminate()});return b.promise()},f.push=function(f){if(d.length>0){var g=d.dequeue();g.assign(f)}else c.push(f),b>e&&(e++,a.newWorker())},f.shards_waiting=function(){return c.length},f}function m(){this.resolved=!1,this.resolve=function(a){this.resolved=!0,this.value=a},this.promise=function(){if(this.resolved)return Promise.resolve(this.value);var a=new Promise(function(a){this.resolved?a(this.value):this.resolve=a}.bind(this));return a}}function n(a,b){var c={};return c.shard=function(c){function d(a){var c=new m;e.push(c.promise()),b.push({completion:c,data:a})}for(var e=[];c.length>a;){var f=c.splice(0,a);d(f)}return d(c),e},c}function o(a){this.dispatcher=a}function p(a,b){this.id=a,this.cfg=b,this.dispatcher=new d,this.dispatcher.usesPromises(new e),this.idle=c}function q(){function a(){var a="worker-"+m.next(),d=new p(a,g);d.idle=function(){h.idling(d)},k[a]=d,self.Worker?c(a,d):b(a,d)}function b(a,b){f.withReplyTo({command:t.spawn,id:a}).then(function(a){var c=a.transfered[0];b.openedChannel(c)})}function c(a,b){var c=new Worker(g.worker);c.postMessage({command:"giraffe:web-worker-init",id:a}),b.openedChannel(c,!0)}var f=new d;f.usesPromises(new e),f.defaultHandler=function(a){a.replyTo?self.postMessage({command:a.replyTo,error:"Command "+a.command+" is not implemented"}):console.error("[supervisor] Default message handler invoked for",a)};var g;f.register(r.initialize,function(a){g=a.config,h=l(j,(g.workers||{}).maxmium||6),i=n((g.sharding||{}).maximumSize||100,h)});var h,i,j;f.repliesTo("feed",function(a,b){var c=a.batch,d=i.shard(c);return d.forEach(function(a){a.then(function(a){b(a)})}),Promise.all(d).then(function(a){var b=[];return a.forEach(function(a){b=b.concat(a)}),b})}),j={newWorker:function(){a()}};var k={},m=new e;f.linkPort(self,!0)}b["true"]=a,d.prototype.register=function(a,b){this.handlers[a]=b},d.prototype.unregister=function(a){delete this.handlers[a]},d.prototype.dispatch=function(a,b){var c=a.command,d=this.handlers[c]||this.defaultHandler;d(a,b)},d.prototype.once=function(a,b){if(!a)throw new Error("name not defined");if(!b)throw new Error("handler not defined");return this.register(a,function(c,d){this.unregister(a),b(c,d)}.bind(this)),a},d.prototype.promiseMessage=function(a){if(!a)throw new Error("command name must be defined");var b,c;return this.once(a,function(a,d){if(a.transfered)throw new Error("Transfer list clobbered");d&&d.ports&&d.ports.length>0&&(a.transfered=d.ports),c?c(a):b=a}),new Promise(function(a){b?a(b):c=a})},d.prototype.linkChannel=function(a){a.addEventListener("message",function(a){this.dispatch(a.data,a)}.bind(this))},e.prototype.next=function(){var a=this.id;return this.id++,a.toString(36)},d.prototype.usesPromises=function(a){a&&(this.namer=a),this.withReplyTo=h,this.withProgressAndReplyTo=g,this.repliesTo=f},d.prototype.linkPort=function(a,b){this.port=a,this.send=i,this.linkChannel(a),b||this.port.start()},d.prototype.reportUnhandled=function(a){this.defaultHandler=function(b){console.warn("[",a,"] Unhandled message: ",b)}};var r={initialize:"giraffe:supervisor:initialize",initialized:"giraffe:supervisor:initialized",batch:"giraffe:supervisor:batch",result:"giraffe:supervisor:result"},s={initialize:"giraffe:work-agent:initialize",initialized:"giraffe:work-agent:initialized",started:"giraffe:work-agent:started",operation:"giraffe:work-agent:operation"},t={spawn:"giraffe:worker-factory:spawn"};o.prototype.spawn=function(a){return this.dispatcher.withReplyTo({command:t.spawn,config:a})},p.prototype.openedChannel=function(a,b){if(!a)throw new Error("channel");return this.channel=a,this.dispatcher.linkPort(a,b),this.dispatcher.withReplyTo({command:s.initialize,id:this.id,config:this.cfg}).then(function(){this.idle()}.bind(this))},p.prototype.dial=function(){if(!this.channel)throw new Error("no channel established to dial on");return this.channel.postMessage({command:"girafe:work-agent:initialize",id:this.id,config:this.cfg}),self},p.prototype.assign_work=function(a){return this.dispatcher.withReplyTo({command:s.operation,on:a})},p.prototype.assign=function(a){return this.assign_work(a.data).then(function(b){a.completion.resolve(b)})},q()}({},function(){return this}());